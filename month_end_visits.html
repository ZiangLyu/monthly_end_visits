<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çªå‡»æ‹œè®¿æŸ¥è¯¢ç³»ç»Ÿ (æœˆæœ«é›†ä¸­æ‹œè®¿)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { font-size: 16px; opacity: 0.9; }
        .content { padding: 30px; }
        .section { margin-bottom: 40px; padding: 25px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e9ecef; }
        .section-title { font-size: 20px; color: #374151; margin-bottom: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .upload-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .upload-card { background: white; border-radius: 10px; padding: 20px; border: 2px solid #e9ecef; }
        .upload-card h3 { font-size: 16px; color: #374151; margin-bottom: 12px; }
        .upload-area { border: 3px dashed #667eea; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: white; }
        .upload-area:hover { background: #f3f4f6; border-color: #5568d3; }
        .upload-area.dragover { background: #eef2ff; border-color: #4f46e5; }
        .upload-area input { display: none; }
        .upload-icon { font-size: 40px; margin-bottom: 10px; }
        .upload-text { color: #667eea; font-weight: 600; font-size: 15px; margin-bottom: 8px; }
        .upload-hint { color: #6b7280; font-size: 13px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e5e7eb; background: white; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f3f4f6; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        th { font-weight: 600; color: #374151; font-size: 14px; position: sticky; top: 0; background: #f3f4f6; z-index: 1; }
        td { color: #6b7280; font-size: 14px; }
        tbody tr:hover { background: #f9fafb; }
        .status-message { padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 14px; }
        .status-success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state-icon { font-size: 64px; margin-bottom: 15px; opacity: 0.5; }
        .badge { display: inline-block; padding: 6px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; background: #eef2ff; color: #4f46e5; }
        .badge-total { background: #fee2e2; color: #991b1b; } 
        .instructions { background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .instructions h4 { color: #1e40af; margin-bottom: 10px; font-size: 16px; }
        .instructions ul { margin-left: 20px; color: #1e3a8a; line-height: 1.8; }
        .instructions li { margin-bottom: 5px; }
        .filter-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; margin-bottom: 20px; }
        .filter-item label { display: block; font-size: 14px; margin-bottom: 5px; color: #4b5563; font-weight: 500; }
        .filter-item input, .filter-item select { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .filter-item input:focus, .filter-item select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15); }
        .filter-section-label { grid-column: 1 / -1; font-size: 14px; font-weight: 600; color: #374151; padding: 8px 12px; background: #eef2ff; border-radius: 6px; border-left: 4px solid #667eea; }
        
        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 20px; background: white; border-radius: 10px; border: 1px solid #e5e7eb; flex-wrap: wrap; gap: 15px; }
        .pagination-info { color: #6b7280; font-size: 14px; }
        .pagination-info strong { color: #374151; font-weight: 600; }
        .pagination-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .page-btn, .page-number { padding: 8px 16px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; color: #374151; transition: all 0.3s; }
        .page-btn:hover:not(:disabled), .page-number:hover { background: #f3f4f6; border-color: #667eea; }
        .page-number.active { background: #667eea; color: white; border-color: #667eea; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-numbers { display: flex; gap: 5px; }
        .page-size-selector { display: flex; align-items: center; gap: 10px; }
        .page-size-selector label { color: #6b7280; font-size: 14px; }
        .page-size-selector select { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; cursor: pointer; background: white; color: #374151; }

        /* å¤§åŒºç»Ÿè®¡æ ·å¼ */
        .region-summary { margin-top: 25px; padding: 20px; background: white; border-radius: 10px; border: 2px solid #e9ecef; }
        .region-summary-title { font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .region-summary-desc { font-size: 14px; color: #6b7280; margin-bottom: 15px; line-height: 1.6; }
        .region-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .region-card { background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%); border-radius: 10px; padding: 18px; border: 2px solid #c7d2fe; transition: all 0.3s; cursor: pointer; position: relative; user-select: none; }
        .region-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25); border-color: #818cf8; }
        .region-card.active { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(79, 70, 229, 0.35); border-color: #4f46e5; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .region-card-name { font-size: 15px; font-weight: 600; color: #4338ca; margin-bottom: 8px; word-break: break-all; }
        .region-card-count { font-size: 28px; font-weight: 700; color: #ef4444; line-height: 1; }
        .region-card-unit { font-size: 13px; color: #6b7280; margin-top: 4px; }
        .region-card-hint { font-size: 12px; color: #818cf8; margin-top: 8px; font-weight: 500; }
        .region-card.active .region-card-hint { color: #4338ca; }
        .region-card.unknown { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #fbbf24; }
        .region-card.unknown:hover { border-color: #f59e0b; box-shadow: 0 6px 20px rgba(245, 158, 11, 0.25); }
        .region-card.unknown.active { border-color: #d97706; box-shadow: 0 6px 20px rgba(217, 119, 6, 0.35); background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%); }
        .region-card.unknown .region-card-name { color: #92400e; }
        .region-card.unknown .region-card-hint { color: #b45309; }

        .area-detail-panel { overflow: hidden; max-height: 0; opacity: 0; transition: all 0.4s ease; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-radius: 12px; border: 2px solid #c4b5fd; margin-bottom: 0; padding: 0 20px; }
        .area-detail-panel.open { max-height: 2000px; opacity: 1; margin-bottom: 15px; padding: 20px; }
        .area-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .area-detail-title { font-size: 16px; font-weight: 600; color: #5b21b6; }
        .area-detail-close { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #c4b5fd; background: white; color: #7c3aed; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .area-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .area-card { background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd6fe; }
        .area-card-name { font-size: 14px; font-weight: 600; color: #6d28d9; margin-bottom: 6px; word-break: break-all; }
        .area-card-count { font-size: 22px; font-weight: 700; color: #ef4444; }
        .region-summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .region-summary-table th, .region-summary-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .region-summary-table th { background: #f3f4f6; font-weight: 600; color: #374151; font-size: 14px; }
        .region-summary-table td { color: #6b7280; font-size: 14px; }
        .region-summary-table .count-cell { font-weight: 700; color: #ef4444; font-size: 16px; }
        .region-summary-table .percent-cell { color: #667eea; font-weight: 600; }
        .region-summary-table tbody tr:hover { background: #f9fafb; }
        .region-total-bar { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 12px 15px; background: #fef2f2; border-radius: 8px; border: 1px solid #fca5a5; }
        .region-total-bar strong { color: #991b1b; font-size: 15px; }
        .region-total-bar span { color: #ef4444; font-size: 20px; font-weight: 700; }

        .cleanup-section { background: #fef2f2; border: 2px solid #fca5a5; }
        .cleanup-warning { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .cleanup-warning h4 { color: #92400e; margin-bottom: 10px; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .cleanup-warning p { color: #78350f; line-height: 1.6; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>çªå‡»æ‹œè®¿æŸ¥è¯¢ç³»ç»Ÿ (æœˆæœ«é›†ä¸­æ‹œè®¿)</h1>
            <p>ç­›é€‰ç­›é€‰â€œå‰24å¤©é›¶æ‹œè®¿ï¼Œä»…åœ¨25å·åŠä»¥åæ‰å¼€å§‹æ‹œè®¿â€çš„ä¸šåŠ¡å‘˜åŠå…¶è®°å½•</p>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title"><span>Step 1</span> ä¸Šä¼ æ•°æ®è¡¨</div>
                <div class="upload-row">
                    <div class="upload-card">
                        <h3>æ‹œè®¿æ˜ç»†è®°å½•è¡¨</h3>
                        <div class="instructions">
                            <ul>
                                <li>æ”¯æŒ Excel (.xlsx, .xls) æ–‡ä»¶</li>
                                <li>å¿…é¡»åŒ…å«åˆ—ï¼šæ‹œè®¿è®°å½•ç¼–å·ã€æ‹œè®¿å¼€å§‹æ—¶é—´ã€æ‹œè®¿ç»“æŸæ—¶é—´ã€æ‹œè®¿äººã€å®¢æˆ·åç§°ã€å®¢æˆ·ç¼–ç ã€æ‹œè®¿ç”¨æ—¶</li>
                            </ul>
                        </div>
                        <div class="upload-area" id="visitUploadArea" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">ğŸ“‹</div>
                            <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ‹œè®¿æ˜ç»†è®°å½•è¡¨</p>
                            <p class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        </div>
                        <div id="uploadStatus"></div>
                    </div>

                    <div class="upload-card">
                        <h3>ç»ˆç«¯é—¨åº—æ¸…å•è¡¨</h3>
                        <div class="instructions">
                            <ul>
                                <li>æ”¯æŒ Excel (.xlsx, .xls) æ–‡ä»¶</li>
                                <li>å¿…é¡»åŒ…å«ï¼šå®¢æˆ·ç¼–ç ã€æ‰€å±ç‰‡åŒºã€æ‰€å±å¤§åŒº</li>
                                <li>ç”¨äºè¡¥å……æ‹œè®¿æ˜ç»†è®°å½•è¡¨ä¸­å®¢æˆ·çš„å½’å±ä¿¡æ¯</li>
                            </ul>
                        </div>
                        <div class="upload-area" id="terminalUploadArea" onclick="document.getElementById('terminalFileInput').click()">
                            <div class="upload-icon">ğŸ¢</div>
                            <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç»ˆç«¯é—¨åº—æ¸…å•è¡¨</p>
                            <p class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                            <input type="file" id="terminalFileInput" accept=".xlsx,.xls" onchange="handleTerminalFileSelect(event)">
                        </div>
                        <div id="terminalUploadStatus"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title"><span>Step 2</span> æŸ¥è¯¢ç»“æœ</div>

                <div class="filter-form">
                    <div class="filter-section-label">æ ¸å¿ƒç­›é€‰æ¡ä»¶</div>
                    <div class="filter-item">
                        <label for="targetMonth">ç­›é€‰æœˆä»½ (å¿…å¡«)</label>
                        <input type="month" id="targetMonth" title="ç³»ç»Ÿå°†ç­›é€‰è¯¥æœˆ1-24å·0æ¬¡æ‹œè®¿çš„äºº">
                    </div>
                    <div class="filter-item">
                        <label for="minCount">æœˆæœ«æ€»æ¬¡æ•° (25-31å·) å¿…é¡» >=</label>
                        <input type="number" id="minCount" value="1" min="1">
                    </div>
                    
                    <div class="filter-section-label">å…¶ä»–ç­›é€‰</div>
                    <div class="filter-item">
                        <label for="visitor">æ‹œè®¿äºº</label>
                        <input type="text" id="visitor" >
                    </div>
                    <div class="filter-item">
                        <label for="area">æ‰€å±ç‰‡åŒº</label>
                        <input type="text" id="area" >
                    </div>
                    <div class="filter-item">
                        <label for="region">æ‰€å±å¤§åŒº</label>
                        <input type="text" id="region" >
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="queryRecords()">æ‰§è¡ŒæŸ¥è¯¢</button>
                    <button class="btn btn-success" onclick="exportToExcel()" id="exportBtn" style="display: none;">å¯¼å‡ºä¸º Excel</button>
                </div>

                <div id="queryStatus"></div>
                <div id="regionSummaryContainer"></div>
                <div id="resultContainer"></div>
                <div id="paginationContainer" style="display: none;"></div>
            </div>

            <div class="section cleanup-section">
                <div class="section-title"><span>Step 3</span> æ¸…ç†æ•°æ®åº“</div>
                <div class="cleanup-warning">
                    <h4>âš ï¸ è­¦å‘Š</h4>
                    <p><strong>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å½“å‰æ•°æ®åº“åŠå…¶ä¸­çš„æ‰€æœ‰è¡¨å’Œæ•°æ®ï¼</strong></p>
                    <p>åˆ é™¤åæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="cleanupDatabase()">ğŸ—‘ï¸ åˆ é™¤æ•°æ®åº“</button>
                </div>
                <div id="cleanupStatus"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8017/api/audit_visit/monthly_end_visits';
        let currentData = [];
        let currentPage = 1;
        let pageSize = 1000;
        let totalPages = 0;
        let regionAreaMap = {};
        let expandedRegion = null;

        // ============ Visit æ–‡ä»¶ä¸Šä¼  ============
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (jsonData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶ä¸ºç©º</div>';
                        return;
                    }
                    statusDiv.innerHTML = '<div class="status-message status-success">è¯»å–æˆåŠŸï¼Œå…± ' + jsonData.length + ' æ¡ï¼Œæ­£åœ¨ä¸Šä¼ ...</div>';
                    uploadVisitInBatches(jsonData);
                } catch (error) { statusDiv.innerHTML = '<div class="status-message status-error">è§£æå¤±è´¥: ' + error.message + '</div>'; }
            };
            reader.readAsArrayBuffer(file);
        }

        async function uploadVisitInBatches(records) {
            const statusDiv = document.getElementById('uploadStatus');
            const BATCH_SIZE = 5000;
            const totalBatches = Math.ceil(records.length / BATCH_SIZE);
            let totalInserted = 0;

            try {
                for (let i = 0; i < totalBatches; i++) {
                    const batch = records.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨ä¸Šä¼ ç¬¬ ' + (i + 1) + '/' + totalBatches + ' æ‰¹...</div>';
                    const response = await fetch(API_URL + '/uploadVisit', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ records: batch })
                    });
                    const result = await response.json();
                    if (!result.success) { statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + result.error + '</div>'; return; }
                    totalInserted += batch.length;
                }
                statusDiv.innerHTML = '<div class="status-message status-success">ä¸Šä¼ æˆåŠŸï¼å¯¼å…¥ ' + totalInserted + ' æ¡è®°å½•ã€‚</div>';
            } catch (error) { statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + error.message + '</div>'; }
        }

        // ============ Terminal æ–‡ä»¶ä¸Šä¼  ============
        function handleTerminalFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const statusDiv = document.getElementById('terminalUploadStatus');
            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (jsonData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-error">æ–‡ä»¶ä¸ºç©º</div>';
                        return;
                    }
                    uploadTerminalInBatches(jsonData);
                } catch (error) { statusDiv.innerHTML = '<div class="status-message status-error">è§£æå¤±è´¥: ' + error.message + '</div>'; }
            };
            reader.readAsArrayBuffer(file);
        }

        async function uploadTerminalInBatches(records) {
            const statusDiv = document.getElementById('terminalUploadStatus');
            const BATCH_SIZE = 5000;
            const totalBatches = Math.ceil(records.length / BATCH_SIZE);
            let totalInserted = 0;

            try {
                for (let i = 0; i < totalBatches; i++) {
                    const batch = records.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨ä¸Šä¼ ç¬¬ ' + (i + 1) + '/' + totalBatches + ' æ‰¹...</div>';
                    const response = await fetch(API_URL + '/uploadTerminal', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ records: batch })
                    });
                    const result = await response.json();
                    if (!result.success) { statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + result.error + '</div>'; return; }
                    totalInserted += batch.length;
                }
                statusDiv.innerHTML = '<div class="status-message status-success">ä¸Šä¼ æˆåŠŸï¼å¯¼å…¥ ' + totalInserted + ' æ¡è®°å½•ã€‚</div>';
            } catch (error) { statusDiv.innerHTML = '<div class="status-message status-error">ä¸Šä¼ å¤±è´¥: ' + error.message + '</div>'; }
        }

        // ============ æŸ¥è¯¢é€»è¾‘ ============
        async function queryRecords() {
            const targetMonth = document.getElementById('targetMonth').value; 
            const minCount = document.getElementById('minCount').value || 1;
            const visitor = document.getElementById('visitor').value.trim();
            const area = document.getElementById('area').value.trim();
            const region = document.getElementById('region').value.trim();

            if (!targetMonth) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœˆä»½ï¼");
                return;
            }

            const params = new URLSearchParams({ targetMonth, minCount, visitor, area, region });

            const statusDiv = document.getElementById('queryStatus');
            const resultDiv = document.getElementById('resultContainer');
            const paginationDiv = document.getElementById('paginationContainer');
            const regionSummaryDiv = document.getElementById('regionSummaryContainer');

            statusDiv.innerHTML = '<div class="status-message status-info">æ­£åœ¨æŸ¥è¯¢ï¼Œåˆ†æ 25 å·å‰åæ‹œè®¿æƒ…å†µ...</div>';
            resultDiv.innerHTML = '';
            paginationDiv.style.display = 'none';
            regionSummaryDiv.innerHTML = '';
            document.getElementById('exportBtn').style.display = 'none';

            expandedRegion = null;
            regionAreaMap = {};

            try {
                const response = await fetch(API_URL + '/getLateMonthVisits?' + params.toString());
                const result = await response.json();

                if (result.success) {
                    currentData = result.data;
                    currentPage = 1;

                    if (currentData.length === 0) {
                        statusDiv.innerHTML = '<div class="status-message status-info">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„çªå‡»æ‹œè®¿è®°å½•</div>';
                        resultDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®°å½•</h3></div>';
                    } else {
                        totalPages = Math.ceil(currentData.length / pageSize);
                        statusDiv.innerHTML = '<div class="status-message status-success">æŸ¥è¯¢æˆåŠŸï¼å…±æ‰¾åˆ° ' + currentData.length + ' åçªå‡»æ‹œè®¿çš„ä¸šåŠ¡å‘˜ã€‚æŒ‰æœˆæœ«æ€»æ¬¡æ•°é™åºæ’åˆ—ã€‚</div>';
                        buildRegionAreaMap();
                        renderRegionSummary();
                        displayResults();
                        renderPagination();
                        document.getElementById('exportBtn').style.display = 'inline-flex';
                        paginationDiv.style.display = 'block';
                    }
                } else { statusDiv.innerHTML = '<div class="status-message status-error">æŸ¥è¯¢å¤±è´¥: ' + result.error + '</div>'; }
            } catch (error) { statusDiv.innerHTML = '<div class="status-message status-error">æŸ¥è¯¢å¤±è´¥: ' + error.message + '</div>'; }
        }

        // ============ å¤§åŒºç»Ÿè®¡ ============
        function buildRegionAreaMap() {
            regionAreaMap = {};
            currentData.forEach(function(row) {
                var regionName = row.æ‰€å±å¤§åŒº || 'æœªçŸ¥å¤§åŒº';
                var areaName = row.æ‰€å±ç‰‡åŒº || 'æœªçŸ¥ç‰‡åŒº';
                if (!regionAreaMap[regionName]) regionAreaMap[regionName] = {};
                if (!regionAreaMap[regionName][areaName]) regionAreaMap[regionName][areaName] = 0;
                regionAreaMap[regionName][areaName]++;
            });
        }

        function renderRegionSummary() {
            var regionSummaryDiv = document.getElementById('regionSummaryContainer');
            var regionCountMap = {};
            currentData.forEach(row => {
                var regionName = row.æ‰€å±å¤§åŒº || 'æœªçŸ¥å¤§åŒº';
                regionCountMap[regionName] = (regionCountMap[regionName] || 0) + 1;
            });

            var regionList = Object.keys(regionCountMap).map(k => ({ name: k, count: regionCountMap[k] }));
            regionList.sort((a, b) => b.count - a.count);

            var html = '<div class="region-summary"><div class="region-summary-title">å„å¤§åŒºçªå‡»æ‹œè®¿äººå‘˜ç»Ÿè®¡</div>';
            html += '<div class="region-summary-desc">æ¡ä»¶ï¼šæŒ‡å®šæœˆä»½å†…ï¼Œ1-24å·æ— ä»»ä½•æ‹œè®¿ï¼Œä¸”25å·ä¹‹åå¼€å§‹æ‹œè®¿ã€‚</div>';
            html += '<div class="region-cards">';
            regionList.forEach(function(item) {
                var isActive = (expandedRegion === item.name);
                var escapedName = item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += '<div class="region-card' + (item.name === 'æœªçŸ¥å¤§åŒº' ? ' unknown' : '') + (isActive ? ' active' : '') + '" onclick="toggleRegionDetail(\'' + escapedName + '\')">';
                html += '<div class="region-card-name">' + item.name + '</div><div class="region-card-count">' + item.count + '</div><div class="region-card-unit">äºº</div><div class="region-card-hint">' + (isActive ? '&#9650; æ”¶èµ·' : '&#9660; å±•å¼€') + '</div></div>';
            });
            html += '</div><div class="area-detail-panel' + (expandedRegion ? ' open' : '') + '" id="areaDetailPanel"><div id="areaDetailContent"></div></div></div>';

            regionSummaryDiv.innerHTML = html;
            if (expandedRegion) renderAreaDetail(expandedRegion);
        }

        function toggleRegionDetail(regionName) {
            expandedRegion = (expandedRegion === regionName) ? null : regionName;
            renderRegionSummary();
        }

        function renderAreaDetail(regionName) {
            var contentDiv = document.getElementById('areaDetailContent');
            var areaMap = regionAreaMap[regionName];
            if (!areaMap) return;
            var areaList = Object.keys(areaMap).map(k => ({ name: k, count: areaMap[k] }));
            areaList.sort((a, b) => b.count - a.count);
            var html = '<div class="area-detail-header"><div class="area-detail-title"><span>' + regionName + '</span> - å„ç‰‡åŒºäººå‘˜æ˜ç»†</div></div><div class="area-cards">';
            areaList.forEach(function(item) {
                html += '<div class="area-card"><div class="area-card-name">' + item.name + '</div><div class="area-card-count">' + item.count + '</div><div class="area-card-unit">äºº</div></div>';
            });
            html += '</div>';
            contentDiv.innerHTML = html;
        }

        // ============ æ˜¾ç¤ºè¡¨æ ¼ ============
        function displayResults() {
            const resultDiv = document.getElementById('resultContainer');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, currentData.length);
            const pageData = currentData.slice(startIndex, endIndex);

            let tableHTML = '<div class="table-container"><table><thead><tr>';
            tableHTML += '<th>åºå·</th><th>æ‹œè®¿äºº</th>';
            // 25-31å·è¡¨å¤´
            for(let i=25; i<=31; i++) {
                tableHTML += `<th>${i}å·æ¬¡æ•°</th>`;
            }
            tableHTML += '<th>æœˆæœ«æ€»æ¬¡æ•°</th><th>æ‰€å±ç‰‡åŒº</th><th>æ‰€å±å¤§åŒº</th></tr></thead><tbody>';

            pageData.forEach(function(row, index) {
                tableHTML += '<tr>';
                tableHTML += '<td><strong>' + ((currentPage - 1) * pageSize + index + 1) + '</strong></td>';
                tableHTML += '<td>' + (row.æ‹œè®¿äºº || '-') + '</td>';
                
                // 25-31å·æ•°æ®
                for(let i=25; i<=31; i++) {
                    let count = row[`day_${i}`] || 0;
                    tableHTML += `<td><span class="badge ${count>0 ? 'badge-total' : ''}">${count}</span></td>`;
                }

                tableHTML += `<td><span class="badge badge-total" style="background:#fca5a5;color:#991b1b;">${row.æœˆæœ«æ‹œè®¿æ€»æ¬¡æ•° || 0}</span></td>`;
                tableHTML += '<td>' + (row.æ‰€å±ç‰‡åŒº || '-') + '</td>';
                tableHTML += '<td>' + (row.æ‰€å±å¤§åŒº || '-') + '</td>';
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table></div>';
            resultDiv.innerHTML = tableHTML;
        }

        // ============ åˆ†é¡µé€»è¾‘ ============
        function renderPagination() {
            const paginationDiv = document.getElementById('paginationContainer');
            let html = '<div class="pagination-container"><div class="pagination-controls">';
            html += '<button class="page-btn" onclick="goToPage(' + (currentPage - 1) + ')"' + (currentPage === 1 ? ' disabled' : '') + '>ä¸Šä¸€é¡µ</button>';
            html += '<span style="font-size:14px; margin: 0 10px;">ç¬¬ ' + currentPage + ' / ' + totalPages + ' é¡µ</span>';
            html += '<button class="page-btn" onclick="goToPage(' + (currentPage + 1) + ')"' + (currentPage === totalPages ? ' disabled' : '') + '>ä¸‹ä¸€é¡µ</button>';
            html += '</div></div>';
            paginationDiv.innerHTML = html;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            displayResults();
            renderPagination();
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            totalPages = Math.ceil(currentData.length / pageSize);
            currentPage = 1;
            displayResults();
            renderPagination();
        }

        // ============ æ¸…ç†æ•°æ®åº“ ============
        async function cleanupDatabase() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å½“å‰æ•°æ®åº“åŠå…¶ä¸­çš„æ‰€æœ‰æ•°æ®ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            const statusDiv = document.getElementById('cleanupStatus');
            try {
                const res = await fetch(API_URL + '/cleanup', { method: 'POST' });
                const result = await res.json();
                if (result.success) {
                    statusDiv.innerHTML = '<div class="status-message status-success">âœ… æ•°æ®åº“å·²æ¸…ç©ºï¼</div>';
                    
                    // é‡ç½®å‰ç«¯æ‰€æœ‰çŠ¶æ€
                    currentData = [];
                    currentPage = 1;
                    totalPages = 0;
                    regionAreaMap = {};
                    expandedRegion = null;

                    document.getElementById('resultContainer').innerHTML = '';
                    document.getElementById('regionSummaryContainer').innerHTML = '';
                    document.getElementById('queryStatus').innerHTML = '';
                    document.getElementById('paginationContainer').style.display = 'none';
                    document.getElementById('exportBtn').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    document.getElementById('terminalFileInput').value = '';
                    document.getElementById('uploadStatus').innerHTML = '';
                    document.getElementById('terminalUploadStatus').innerHTML = '';

                    setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
                }
            } catch (err) { statusDiv.innerHTML = '<div class="status-message status-error">æ¸…ç©ºå¤±è´¥: ' + err.message + '</div>'; }
        }

        // ============ å¯¼å‡º Excel ============
        function exportToExcel() {
            var exportData = currentData.map((row, index) => {
                let obj = {
                    'åºå·': index + 1,
                    'æ‹œè®¿äºº': row.æ‹œè®¿äºº || '-',
                };
                for(let i=25; i<=31; i++) {
                    obj[`${i}å·æ‹œè®¿æ¬¡æ•°`] = row[`day_${i}`] || 0;
                }
                obj['æœˆæœ«æ‹œè®¿æ€»æ¬¡æ•°'] = row.æœˆæœ«æ‹œè®¿æ€»æ¬¡æ•° || 0;
                obj['æ‰€å±ç‰‡åŒº'] = row.æ‰€å±ç‰‡åŒº || '-';
                obj['æ‰€å±å¤§åŒº'] = row.æ‰€å±å¤§åŒº || '-';
                return obj;
            });

            var wb = XLSX.utils.book_new();
            var ws = XLSX.utils.json_to_sheet(exportData);
            
            let cols = [{ wch: 8 }, { wch: 15 }];
            for(let i=25; i<=31; i++) cols.push({ wch: 12 });
            cols.push({ wch: 15 }, { wch: 15 }, { wch: 15 });
            ws['!cols'] = cols;

            XLSX.utils.book_append_sheet(wb, ws, 'æœˆæœ«çªå‡»æ‹œè®¿æŸ¥è¯¢ç»“æœ');
            XLSX.writeFile(wb, 'çªå‡»æ‹œè®¿åˆ†æ_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        // æ‹–æ‹½
        ['visitUploadArea', 'terminalUploadArea'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('dragover'); });
            el.addEventListener('dragleave', e => { e.preventDefault(); el.classList.remove('dragover'); });
            el.addEventListener('drop', e => {
                e.preventDefault(); el.classList.remove('dragover');
                document.getElementById(id === 'visitUploadArea' ? 'fileInput' : 'terminalFileInput').files = e.dataTransfer.files;
                (id === 'visitUploadArea' ? handleFileSelect : handleTerminalFileSelect)({ target: document.getElementById(id === 'visitUploadArea' ? 'fileInput' : 'terminalFileInput') });
            });
        });
    </script>
</body>
</html>